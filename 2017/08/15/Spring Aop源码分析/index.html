<!DOCTYPE html>
<html lang="zh">
    <head>
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.4 -->

    <!-- Title -->
    
    <title>
        
            Spring Aop源码分析 | 
        
        游思达的博客
    </title>

    <!-- Meta & Info -->
    <meta charset="utf-8">

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    

    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="游思达">
    <meta name="description" content="落霞与孤鹜齐飞，秋水共长天一色。">
    <meta name="keywords" content="null">

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="游思达的博客">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Spring Aop源码分析 | 游思达的博客">
    <meta property="og:description" content="落霞与孤鹜齐飞，秋水共长天一色。">
    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS & jQuery -->
    
        <link rel="stylesheet" href="/css/material.min.css">
        <link rel="stylesheet" href="/css/style.min.css">
        <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


        <script src="/js/jquery.min.js"></script>
        <script src="/js/queue.js"></script>
    

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    


    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Advice"><span class="post-toc-number">1.</span> <span class="post-toc-text">Advice</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Pointcut"><span class="post-toc-number">2.</span> <span class="post-toc-text">Pointcut</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Advisor"><span class="post-toc-number">3.</span> <span class="post-toc-text">Advisor</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#建立AopProxy代理对象"><span class="post-toc-number">4.</span> <span class="post-toc-text">建立AopProxy代理对象</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#getObject"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">getObject</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#initializeAdvisorChain"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">initializeAdvisorChain</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#getSingletonInstance"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">getSingletonInstance</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#createAopProxy"><span class="post-toc-number">4.3.1.</span> <span class="post-toc-text">createAopProxy</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#getProxy"><span class="post-toc-number">4.3.2.</span> <span class="post-toc-text">getProxy</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Jdk生成AopProxy代理对象"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">Jdk生成AopProxy代理对象</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#流程图"><span class="post-toc-number">4.5.</span> <span class="post-toc-text">流程图</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#拦截器调用的实现"><span class="post-toc-number">5.</span> <span class="post-toc-text">拦截器调用的实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#invoke"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">invoke</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#获取拦截器链"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">获取拦截器链</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#生成拦截器链"><span class="post-toc-number">5.3.</span> <span class="post-toc-text">生成拦截器链</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#GlobalAdvisorAdapterRegistry"><span class="post-toc-number">5.3.1.</span> <span class="post-toc-text">GlobalAdvisorAdapterRegistry</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#getInterceptors"><span class="post-toc-number">5.3.2.</span> <span class="post-toc-text">getInterceptors</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#AdvisorAdapter"><span class="post-toc-number">5.3.3.</span> <span class="post-toc-text">AdvisorAdapter</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#MethodBeforeAdviceInterceptor"><span class="post-toc-number">5.4.</span> <span class="post-toc-text">MethodBeforeAdviceInterceptor</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Aop拦截器链调用"><span class="post-toc-number">5.5.</span> <span class="post-toc-text">Aop拦截器链调用</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#源码"><span class="post-toc-number">5.6.</span> <span class="post-toc-text">源码</span></a></li></ol></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                Spring Aop源码分析
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/FaceImage.jpg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>游思达</strong>
        <span>8月 15, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=Spring Aop源码分析&url=http://yoursite.com//2017/08/15/Spring Aop源码分析/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=Spring Aop源码分析&url=http://yoursite.com//2017/08/15/Spring Aop源码分析/index.html&via=游思达" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com//2017/08/15/Spring Aop源码分析/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com//2017/08/15/Spring Aop源码分析/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h2 id="Advice"><a href="#Advice" class="headerlink" title="Advice"></a>Advice</h2><p><code>Advice</code>通知定义在连接点做什么。</p>
<p><code>Advice</code>是<code>Aop</code>联盟定义的接口，在<code>Spring Aop</code>中使用此接口，提供更具体的通知类型，如<code>MethodBeforeAdvice</code>和<code>MethodAfterAdvice</code>等。</p>
<p>在<code>MethodBeforeAdvice</code>接口中，需实现</p>
<p><code>void before(Method method,Object[] args,Object target)throws Throwable</code></p>
<p>在调用目标方法前被<code>Spring Aop</code>调用。</p>
<ul>
<li>Method：目标方法</li>
<li>Object[]：目标方法参数</li>
</ul>
<h2 id="Pointcut"><a href="#Pointcut" class="headerlink" title="Pointcut"></a>Pointcut</h2><p><code>Pointcut</code>决定<code>Advice</code>通知作用于哪个连接点。</p>
<p><code>ClassFilter</code>类似类的过滤器，根据类名过滤。</p>
<p><code>MethodMatcher</code>确定类方法是否应用通知。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public interface Pointcut&#123;</div><div class="line">	//决定类是否应用通知.</div><div class="line">	ClassFilter getClassFilter();</div><div class="line"></div><div class="line">	//通过返回的MethodMatcher来判断是否对当前方法应用Advice通知.</div><div class="line">	MethodMatcher getMethodMatcher();</div><div class="line"></div><div class="line">	Pointcut TRUE=TruePointcut.INSTANCE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中<code>JdkRegexpMethodPointcut</code>通过正则表达式对方法名进行匹配。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">protected boolean matches(String pattern,int patternIndex)&#123;</div><div class="line">		//通过JDK实现正则表达式对匹配.</div><div class="line">		Matcher matcher=this.compiledPatterns[patternIndex].matcher(pattern);</div><div class="line">		return matcher.matches();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Advisor"><a href="#Advisor" class="headerlink" title="Advisor"></a>Advisor</h2><p>完成目标方法的切面增强设计<code>Advice</code>和关注点设计<code>Pointcut</code>后，使用<code>Advisor</code>将其结合起来。</p>
<p>通过<code>Advisor</code>定义在哪个关注点使用哪个通知。</p>
<p>在<code>DefaultPointcutAdvisor</code>中，有<code>advice</code>属性和<code>pointcut</code>属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">public class DefaultPointcutAdvisor extends AbstractGenericPointcutAdvisor implements Serializable&#123;</div><div class="line"></div><div class="line">	private Pointcut pointcut=Pointcut.TRUE;</div><div class="line"></div><div class="line">	public DefaultPointcutAdvisor()&#123;&#125;</div><div class="line">	</div><div class="line">	public DefaultPointcutAdvisor(Advice advice)&#123;</div><div class="line">		this(Pointcut.TRUE,advice);</div><div class="line">	&#125;</div><div class="line">	public DefaultPointcutAdvisor(Pointcut pointcut,Advice advice)&#123;</div><div class="line">		this.pointcut=pointcut;</div><div class="line">		setAdvice(advice);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public Pointcut getPointcut()&#123;</div><div class="line">		return this.pointcut;</div><div class="line">	&#125;</div><div class="line">	public void setPointcut(Pointcut pointcut)&#123;</div><div class="line">		this.pointcut=(pointcut != null ? pointcut : Pointcut.TRUE);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	@Override</div><div class="line">	public String toString()&#123;</div><div class="line">		return getClass().getName()+&quot;: pointcut [&quot;+getPointcut()+&quot;]; advice [&quot;+getAdvice()+&quot;]&quot;;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Pointcut True=TruePointcut.INSTANCE</code>，<code>INSTANCE</code>是一个单件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">class TruePointcut implements Pointcut,Serializable&#123;</div><div class="line"></div><div class="line">	public static final TruePointcut INSTANCE=new TruePointcut();</div><div class="line"></div><div class="line">	private TruePointcut()&#123;&#125;</div><div class="line"></div><div class="line">	//任何类匹配要求.返回True.</div><div class="line">	@Override</div><div class="line">	public ClassFilter getClassFilter()&#123;</div><div class="line">		return ClassFilter.TRUE;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	//对任何方法的匹配要求.返回True.</div><div class="line">	@Override</div><div class="line">	public MethodMatcher getMethodMatcher()&#123;</div><div class="line">		return MethodMatcher.TRUE;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	private Object readResolve()&#123;</div><div class="line">		return INSTANCE;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public String toString()&#123;</div><div class="line">		return &quot;Pointcut.TRUE&quot;;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>True MethodMatcher</code>单件，它的<code>matches</code>方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public boolean matches(Method method,Class targetClass)&#123;</div><div class="line">    return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="建立AopProxy代理对象"><a href="#建立AopProxy代理对象" class="headerlink" title="建立AopProxy代理对象"></a>建立AopProxy代理对象</h2><p>通过配置和调用<code>ProxyFactoryBean</code>完成代理对象的生成，可以使用<code>JDK</code>代理和<code>CGLIB</code>两种方式。</p>
<p><code>ProxyFactoryBean</code>是<code>Spring</code>环境中创建<code>AOP</code>应用底层方法。</p>
<p>对<code>target</code>目标对象的增强，通过<code>ProxyFactory</code>的<code>getObject</code>方法完成。</p>
<h3 id="getObject"><a href="#getObject" class="headerlink" title="getObject"></a>getObject</h3><ul>
<li>对通知器链进行初始化，通知器链封装一系列通知器。</li>
<li>创建代理对象。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public Object getObject()throws BeansException&#123;</div><div class="line">	//初始化通知器链.</div><div class="line">	initializeAdvisorChain();</div><div class="line"></div><div class="line">	//对Singleton和Prptotype的类型进行区分.生成对应的Proxy.</div><div class="line">	if(isSingleton())&#123;</div><div class="line">		return getSingletonInstance();</div><div class="line">	&#125;else&#123;</div><div class="line">		if(this.targetName == null)&#123;</div><div class="line">			logger.warn(&quot;Using non-singleton proxies with singleton targets is often undesirable.&quot;+</div><div class="line">					&quot;Enable prototype proxies by setting the &apos;targetName&apos; property.&quot;);</div><div class="line">		&#125;</div><div class="line">		return newPrototypeInstance();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="initializeAdvisorChain"><a href="#initializeAdvisorChain" class="headerlink" title="initializeAdvisorChain"></a>initializeAdvisorChain</h3><p>初始化通知器链有一个标志位<code>advisorChainInitialized</code>，表示通知器链是否已经初始化，如果已经初始化返回。</p>
<p>初始化后，读取配置文件中的<code>interceptorNames</code>（配置的通知、拦截器）<code>Bean</code>，通过<code>addAdvisorOnChainCreation</code>将<code>Bean</code>转换<code>Advice</code>（<code>Bean</code>是<code>Object</code>类型）再转换<code>adviosr</code>后加入通知器链。</p>
<p>初始化发生在首次通过<code>ProxyFactoryBean</code>获取对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">private synchronized void initializeAdvisorChain()throws AopConfigException,BeansException&#123;</div><div class="line">	if(this.advisorChainInitialized)&#123;</div><div class="line">		return;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if(!ObjectUtils.isEmpty(this.interceptorNames))&#123;</div><div class="line">		if(this.beanFactory == null)&#123;</div><div class="line">			throw new IllegalStateException(&quot;No BeanFactory available anymore (probably due to serialization) &quot;+</div><div class="line">					&quot;- cannot resolve interceptor names &quot;+Arrays.asList(this.interceptorNames));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		if(this.interceptorNames[this.interceptorNames.length-1].endsWith(GLOBAL_SUFFIX) &amp;&amp;</div><div class="line">				this.targetName == null &amp;&amp; this.targetSource == EMPTY_TARGET_SOURCE)&#123;</div><div class="line">			throw new AopConfigException(&quot;Target required after globals&quot;);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		//遍历interceptorNames获取所有通知器.</div><div class="line">		for(String name : this.interceptorNames)&#123;</div><div class="line">			if(logger.isTraceEnabled())&#123;</div><div class="line">				logger.trace(&quot;Configuring advisor or advice&apos;&quot;+name+&quot;&apos;&quot;);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			if(name.endsWith(GLOBAL_SUFFIX))&#123;</div><div class="line">				if(!(this.beanFactory instanceof ListableBeanFactory))&#123;</div><div class="line">					throw new AopConfigException(</div><div class="line">							&quot;Can only use global advisors or interceptors with a ListableBeanFactory&quot;);</div><div class="line">				&#125;</div><div class="line">				addGlobalAdvisor((ListableBeanFactory)this.beanFactory,</div><div class="line">						name.substring(0,name.length()-GLOBAL_SUFFIX.length()));</div><div class="line">			&#125;else&#123;</div><div class="line">				//加入命名的advice.并且检查类型.</div><div class="line">				Object advice;</div><div class="line">				if(this.singleton || this.beanFactory.isSingleton(name))&#123;</div><div class="line">					advice=this.beanFactory.getBean(name);</div><div class="line">				&#125;else&#123;</div><div class="line">					advice=new PrototypePlaceholderAdvisor(name);</div><div class="line">				&#125;</div><div class="line">				addAdvisorOnChainCreation(advice,name);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	this.advisorChainInitialized=true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="getSingletonInstance"><a href="#getSingletonInstance" class="headerlink" title="getSingletonInstance"></a>getSingletonInstance</h3><p>生成单例代理对象在<code>getSingletonInstance</code>方法中完成。</p>
<p>目标对象的方法调用被代理对象拦截，调用<code>invoke</code>方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">private synchronized Object getSingletonInstance()&#123;</div><div class="line">	if(this.singletonInstance == null)&#123;</div><div class="line">		this.targetSource=freshTargetSource();</div><div class="line">		if(this.autodetectInterfaces &amp;&amp; getProxiedInterfaces().length == 0 &amp;&amp; !isProxyTargetClass())&#123;</div><div class="line">			//根据AOP框架来判断需要代理的接口.</div><div class="line">			Class&lt;?&gt; targetClass=getTargetClass();</div><div class="line">			if(targetClass == null)&#123;</div><div class="line">				throw new FactoryBeanNotInitializedException(&quot;Cannot determine target class for proxy&quot;);</div><div class="line">			&#125;</div><div class="line">			//设置代理对象接口.</div><div class="line">			setInterfaces(ClassUtils.getAllInterfacesForClass(targetClass,this.proxyClassLoader));</div><div class="line">		&#125;</div><div class="line">		super.setFrozen(this.freezeProxy);</div><div class="line">		//使用ProxyFactory生成需要的Proxy.</div><div class="line">		this.singletonInstance=getProxy(createAopProxy());</div><div class="line">	&#125;</div><div class="line">	return this.singletonInstance;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="createAopProxy"><a href="#createAopProxy" class="headerlink" title="createAopProxy"></a>createAopProxy</h4><p><code>Spring</code>利用<code>AopProxy</code>接口将代理对象的实现和框架分离，<code>AopProxy</code>有两个子类（<code>CGLIB</code>和<code>JDK</code>）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public interface AopProxy&#123;</div><div class="line">	Object getProxy();</div><div class="line">	//指定ClassLoader.</div><div class="line">	Object getProxy(ClassLoader classLoader);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用<code>AopProxyFactory</code>创建<code>AopProxy</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">protected final synchronized AopProxy createAopProxy()&#123;</div><div class="line">	if(!this.active)&#123;</div><div class="line">		activate();</div><div class="line">	&#125;</div><div class="line">	return getAopProxyFactory().createAopProxy(this);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>AopProxy</code>代理对象生成，如果目标对象接口类，使用<code>JDK</code>生成代理对象，否则使用<code>CGLIB</code>生成代理对象。</p>
<p><code>createAopProxy</code>关键代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//如果targetClass是接口类.</div><div class="line">if(targetClass.isInterface() || Proxy.isProxyClass(targetClass))&#123;</div><div class="line">	return new JdkDynamicAopProxy(config);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>//如果不是接口类.
return new ObjenesisCglibAopProxy(config);</code></p>
<h4 id="getProxy"><a href="#getProxy" class="headerlink" title="getProxy"></a>getProxy</h4><p>通过<code>createAopProxy</code>返回实现<code>AopProxy</code>接口的对象获得代理对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">protected Object getProxy(AopProxy aopProxy)&#123;</div><div class="line">		return aopProxy.getProxy(this.proxyClassLoader);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Jdk生成AopProxy代理对象"><a href="#Jdk生成AopProxy代理对象" class="headerlink" title="Jdk生成AopProxy代理对象"></a>Jdk生成AopProxy代理对象</h3><p><code>JdkDynamicAopProxy</code>实现了<code>InvocationHandler</code>接口和<code>invoke</code>方法，可以使用<code>this</code>把<code>JdkDynamicAopProxy</code>指派给代理对象。</p>
<p><code>final class JdkDynamicAopProxy implements AopProxy,InvocationHandler,Serializable</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public Object getProxy(ClassLoader classLoader)&#123;</div><div class="line">	if(logger.isDebugEnabled())&#123;</div><div class="line">		logger.debug(&quot;Creating JDK dynamic proxy: target source is &quot;+this.advised.getTargetSource());</div><div class="line">	&#125;</div><div class="line">	Class&lt;?&gt;[] proxiedInterfaces=AopProxyUtils.completeProxiedInterfaces(this.advised,true);</div><div class="line">	findDefinedEqualsAndHashCodeMethods(proxiedInterfaces);</div><div class="line">	//类加载器.代理接口.实现InvocationHandler接口的对象.</div><div class="line">	return Proxy.newProxyInstance(classLoader,proxiedInterfaces,this);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在<code>ProxyFactory</code>中配置的<code>target</code>目标对象，不会让其他应用直接调用，被<code>AopProxy</code>生成代理对象拦截。</p>
<h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><p><img src="\img\实习\27.png" alt="image"></p>
<h2 id="拦截器调用的实现"><a href="#拦截器调用的实现" class="headerlink" title="拦截器调用的实现"></a>拦截器调用的实现</h2><h3 id="invoke"><a href="#invoke" class="headerlink" title="invoke"></a>invoke</h3><p>当代理对象代理方法被调用时，<code>invoke</code>方法回调，完成目标方法的增强。</p>
<ul>
<li>获取拦截器链（通过目标对象方法、目标对象<code>Class</code>）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">public Object invoke(Object proxy,Method method,Object[] args)throws Throwable&#123;</div><div class="line">	MethodInvocation invocation;</div><div class="line">	Object oldProxy=null;</div><div class="line">	boolean setProxyContext=false;</div><div class="line"></div><div class="line">	TargetSource targetSource=this.advised.targetSource;</div><div class="line">	Class&lt;?&gt; targetClass=null;</div><div class="line">	Object target=null;</div><div class="line"></div><div class="line">	try&#123;</div><div class="line">		if(!this.equalsDefined &amp;&amp; AopUtils.isEqualsMethod(method))&#123;</div><div class="line">			//如果目标对象没有实现Object类的基本方法equals.</div><div class="line">			return equals(args[0]);</div><div class="line">		&#125;else if(!this.hashCodeDefined &amp;&amp; AopUtils.isHashCodeMethod(method))&#123;</div><div class="line">			//如果目标对象没有实现Object类的基本方法hasCode.</div><div class="line">			return hashCode();</div><div class="line">		&#125;else if(method.getDeclaringClass() == DecoratingProxy.class)&#123;</div><div class="line">			//根据代理对象的配置调用服务.</div><div class="line">			return AopProxyUtils.ultimateTargetClass(this.advised);</div><div class="line">		&#125;else if(!this.advised.opaque &amp;&amp; method.getDeclaringClass().isInterface() &amp;&amp;</div><div class="line">				method.getDeclaringClass().isAssignableFrom(Advised.class))&#123;</div><div class="line">			return AopUtils.invokeJoinpointUsingReflection(this.advised,method,args);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Object retVal;</div><div class="line"></div><div class="line">		if(this.advised.exposeProxy)&#123;</div><div class="line">			oldProxy=AopContext.setCurrentProxy(proxy);</div><div class="line">			setProxyContext=true;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		//获得目标对象.</div><div class="line">		target=targetSource.getTarget();</div><div class="line">		if(target != null)&#123;</div><div class="line">			targetClass=target.getClass();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		//获得拦截器链.</div><div class="line">		List&lt;Object&gt; chain=this.advised.getInterceptorsAndDynamicInterceptionAdvice(method,targetClass);</div><div class="line"></div><div class="line">		//如果没有设定拦截器.直接调用target对应的方法.</div><div class="line">		if(chain.isEmpty())&#123;</div><div class="line">			Object[] argsToUse=AopProxyUtils.adaptArgumentsIfNecessary(method,args);</div><div class="line">			retVal=AopUtils.invokeJoinpointUsingReflection(target,method,argsToUse);</div><div class="line">		&#125;else&#123;</div><div class="line">			//如果有拦截器设定.需要调用拦截器之后才调用目标对象的对应方法.</div><div class="line">			invocation=new ReflectiveMethodInvocation(proxy,target,method,args,targetClass,chain);</div><div class="line">			//沿着拦截器继续前进.</div><div class="line">			retVal=invocation.proceed();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Class&lt;?&gt; returnType=method.getReturnType();</div><div class="line">		if(retVal != null &amp;&amp; retVal == target &amp;&amp; returnType.isInstance(proxy) &amp;&amp;</div><div class="line">				!RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass())) &#123;</div><div class="line">			retVal=proxy;</div><div class="line">		&#125;else if(retVal == null &amp;&amp; returnType != Void.TYPE &amp;&amp; returnType.isPrimitive())&#123;</div><div class="line">			throw new AopInvocationException(</div><div class="line">					&quot;Null return value from advice does not match primitive return type for:&quot;+method);</div><div class="line">		&#125;</div><div class="line">		return retVal;</div><div class="line">	&#125;finally&#123;</div><div class="line">		if(target != null &amp;&amp; !targetSource.isStatic())&#123;</div><div class="line">			targetSource.releaseTarget(target);</div><div class="line">		&#125;</div><div class="line">		if(setProxyContext)&#123;</div><div class="line">			AopContext.setCurrentProxy(oldProxy);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果没有设置拦截器，直接对目标对象的方法进行调用。</p>
<p><code>return method.invoke(target,args)</code></p>
<h3 id="获取拦截器链"><a href="#获取拦截器链" class="headerlink" title="获取拦截器链"></a>获取拦截器链</h3><ul>
<li>从缓存中获得拦截器链。</li>
<li>缓存中不存在，生成拦截器链。</li>
</ul>
<p>以目标对象的目标方法作为<code>Key</code>，一个类（被代理对象）可能有多个方法设置通知。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public List&lt;Object&gt; getInterceptorsAndDynamicInterceptionAdvice(Method method,Class&lt;?&gt; targetClass)&#123;</div><div class="line">	//使用Cache.利用Cache去获得Inteceptor链.</div><div class="line">	//初次需要自己生成.</div><div class="line">	MethodCacheKey cacheKey=new MethodCacheKey(method);</div><div class="line">	List&lt;Object&gt; cached=this.methodCache.get(cacheKey);</div><div class="line">	if(cached == null)&#123;</div><div class="line">		cached=this.advisorChainFactory.getInterceptorsAndDynamicInterceptionAdvice(</div><div class="line">				this,method,targetClass);</div><div class="line">		this.methodCache.put(cacheKey,cached);</div><div class="line">	&#125;</div><div class="line">	return cached;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="生成拦截器链"><a href="#生成拦截器链" class="headerlink" title="生成拦截器链"></a>生成拦截器链</h3><ul>
<li>获得通知器链的所有通知器。</li>
<li>获取通知器中<code>Advice</code>（判断是否匹配类和方法）封装<code>MethodInterceptor</code>保存在集合中。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">AdvisorAdapterRegistry registry=GlobalAdvisorAdapterRegistry.getInstance();</div><div class="line">//遍历.</div><div class="line">for(Advisor advisor : config.getAdvisors())&#123;</div><div class="line">	if(advisor instanceof PointcutAdvisor)&#123;</div><div class="line">		</div><div class="line">		PointcutAdvisor pointcutAdvisor=(PointcutAdvisor)advisor;</div><div class="line">		</div><div class="line">		//是否当前类的通知器.</div><div class="line">		if(config.isPreFiltered() || pointcutAdvisor.getPointcut().getClassFilter().matches(actualClass))&#123;</div><div class="line">			//将Advisor转换interceptor.</div><div class="line">			//一个通知器可能中的通知可能实现多个Advice接口.即有前置又有后置.</div><div class="line">			MethodInterceptor[] interceptors=registry.getInterceptors(advisor);</div><div class="line">			</div><div class="line">			//是否匹配当前方法.</div><div class="line">			MethodMatcher mm=pointcutAdvisor.getPointcut().getMethodMatcher();</div><div class="line">		</div><div class="line">			if(MethodMatchers.matches(mm,method,actualClass,hasIntroductions))&#123;</div><div class="line">				if(mm.isRuntime())&#123;</div><div class="line">					//在getInterceptors创建新的对象实例.</div><div class="line">					for(MethodInterceptor interceptor : interceptors)&#123;</div><div class="line">						interceptorList.add(new InterceptorAndDynamicMethodMatcher(interceptor,mm));</div><div class="line">					&#125;</div><div class="line">				&#125;else&#123;</div><div class="line">					interceptorList.addAll(Arrays.asList(interceptors));</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="GlobalAdvisorAdapterRegistry"><a href="#GlobalAdvisorAdapterRegistry" class="headerlink" title="GlobalAdvisorAdapterRegistry"></a>GlobalAdvisorAdapterRegistry</h4><p><code>GlobalAdvisorAdapterRegistry</code>有适配器作用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public abstract class GlobalAdvisorAdapterRegistry&#123;</div><div class="line"></div><div class="line">	private static AdvisorAdapterRegistry instance=new DefaultAdvisorAdapterRegistry();</div><div class="line"></div><div class="line">	public static AdvisorAdapterRegistry getInstance()&#123;</div><div class="line">		return instance;</div><div class="line">	&#125;</div><div class="line">	static void reset()&#123;</div><div class="line">		instance= new DefaultAdvisorAdapterRegistry();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="getInterceptors"><a href="#getInterceptors" class="headerlink" title="getInterceptors"></a>getInterceptors</h4><p>一个通知可能实现多个<code>Advice</code>接口。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">public MethodInterceptor[] getInterceptors(Advisor advisor)throws UnknownAdviceTypeException&#123;</div><div class="line">	List&lt;MethodInterceptor&gt; interceptors=new ArrayList&lt;MethodInterceptor&gt;(3);</div><div class="line"></div><div class="line">	//从通知器中获得advice通知.</div><div class="line">	Advice advice=advisor.getAdvice();</div><div class="line">	//若通知类型是MethodInterceptor(拦截器).直接加入List中.不需要适配.</div><div class="line">	if(advice instanceof MethodInterceptor)&#123;</div><div class="line">		interceptors.add((MethodInterceptor)advice);</div><div class="line">	&#125;</div><div class="line">	//对通知进行适配.使用已经配置好的Adapter.</div><div class="line">	for(AdvisorAdapter adapter : this.adapters)&#123;</div><div class="line">		if(adapter.supportsAdvice(advice))&#123;</div><div class="line">			interceptors.add(adapter.getInterceptor(advisor));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	if(interceptors.isEmpty())&#123;</div><div class="line">		throw new UnknownAdviceTypeException(advisor.getAdvice());</div><div class="line">	&#125;</div><div class="line">	return interceptors.toArray(new MethodInterceptor[interceptors.size()]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>//List中的元素与advice增强功能相对应.
private final List&lt;AdvisorAdapter&gt; adapters=new ArrayList&lt;AdvisorAdapter&gt;(3);</code></p>
<h4 id="AdvisorAdapter"><a href="#AdvisorAdapter" class="headerlink" title="AdvisorAdapter"></a>AdvisorAdapter</h4><p>确定在目标方法之前、之后等情况使用。</p>
<p>一个接口，通知的种类实现此接口，<code>MethodBeforeAdviceAdapter</code>、<code>MethodAfterAdviceAdapter</code>、<code>ThrowsAdviceAdapter</code>和<code>AfterReturningAdviceAdapter</code>具体实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public interface AdvisorAdapter&#123;</div><div class="line">	//对advice类型进行判断.</div><div class="line">	boolean supportsAdvice(Advice advice);</div><div class="line"></div><div class="line">	MethodInterceptor getInterceptor(Advisor advisor);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">class MethodBeforeAdviceAdapter implements AdvisorAdapter,Serializable&#123;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public boolean supportsAdvice(Advice advice)&#123;</div><div class="line">		return (advice instanceof MethodBeforeAdvice);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public MethodInterceptor getInterceptor(Advisor advisor)&#123;</div><div class="line">		//将advice通知从通知器中取出来.然后创建MethodBeforeAdvice对象.将advice通知包装起来.</div><div class="line">		MethodBeforeAdvice advice=(MethodBeforeAdvice)advisor.getAdvice();</div><div class="line">		return new MethodBeforeAdviceInterceptor(advice);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="MethodBeforeAdviceInterceptor"><a href="#MethodBeforeAdviceInterceptor" class="headerlink" title="MethodBeforeAdviceInterceptor"></a>MethodBeforeAdviceInterceptor</h3><p><code>MethodBeforeAdviceInterceptor</code>完成对<code>MethodBeforeAdvice</code>通知的封装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">public class MethodBeforeAdviceInterceptor implements MethodInterceptor,Serializable&#123;</div><div class="line"></div><div class="line">	private MethodBeforeAdvice advice;</div><div class="line"></div><div class="line">	//为指定advice创建对应的MethodBeforeAdviceInterceptor对象.</div><div class="line">	public MethodBeforeAdviceInterceptor(MethodBeforeAdvice advice)&#123;</div><div class="line">		Assert.notNull(advice,&quot;Advice must not be null&quot;);</div><div class="line">		this.advice=advice;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	//拦截器的回调方法.在代理对象方法调用时触发回调.</div><div class="line">	public Object invoke(MethodInvocation mi)throws Throwable&#123;</div><div class="line">		//触发advice的before回调.</div><div class="line">		this.advice.before(mi.getMethod(),mi.getArguments(),mi.getThis());</div><div class="line">		return mi.proceed();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Aop拦截器链调用"><a href="#Aop拦截器链调用" class="headerlink" title="Aop拦截器链调用"></a>Aop拦截器链调用</h3><p>使用<code>JDK</code>或<code>CGLIB</code>生成代理对象后，对拦截器的调用在<code>ReflectiveMethodInvocation</code>中<code>proceed</code>方法。</p>
<p>在<code>proceed</code>方法中，逐个调用拦截器的增强方法。</p>
<p>运行拦截器的增强方法前，对代理方法做匹配判断决定拦截器是否满足要求。</p>
<p>在<code>proceed</code>方法中，判断是否运行到拦截器链末位，若运行到末尾，调用目标对象的实现方法，否则，沿着拦截器继续前行。</p>
<p>拦截器链中的通知匹配当前类和当前方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">public Object proceed()throws Throwable&#123;</div><div class="line">	//从索引为-1的拦截器开始调用.并按序递增.</div><div class="line">	if(this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size()-1)&#123;</div><div class="line">		//调用目标对象的方法.</div><div class="line">		return invokeJoinpoint();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Object interceptorOrInterceptionAdvice=</div><div class="line">			this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex);</div><div class="line"></div><div class="line">	if(interceptorOrInterceptionAdvice instanceof InterceptorAndDynamicMethodMatcher)&#123;</div><div class="line">		//对拦截器进行调用.不同通知类型最终调用代理方法的位置不同.</div><div class="line">		InterceptorAndDynamicMethodMatcher dm=</div><div class="line">				(InterceptorAndDynamicMethodMatcher)interceptorOrInterceptionAdvice;</div><div class="line">		if(dm.methodMatcher.matches(this.method,this.targetClass,this.arguments))&#123;</div><div class="line">			return dm.interceptor.invoke(this);</div><div class="line">		&#125;else&#123;</div><div class="line">			//递归调用.</div><div class="line">			return proceed();</div><div class="line">		&#125;</div><div class="line">	&#125;else&#123;</div><div class="line">		//如果是一个Interceptor.直接调用对应的方法.</div><div class="line">		return ((MethodInterceptor)interceptorOrInterceptionAdvice).invoke(this);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><p><img src="\img\实习\28.png" alt="image"></p>

    

    
</div>


                

                <!-- Post Comments -->
                
                    







                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/08/10/Ioc容器依赖注入源码分析/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/SideImage.jpg);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/FaceImage.jpg" alt="游思达's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        553408524@qq.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/08/">八月 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/07/">七月 2017<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/06/">六月 2017<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/05/">五月 2017<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/04/">四月 2017<span class="sidebar_archives-count">4</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/Git/">Git<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/Java-基础/">Java 基础<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/Java基础/">Java基础<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/分布式/">分布式<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/数据结构/">数据结构<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/杂七杂八/">杂七杂八<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/categories/框架/">框架<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/categories/设计模式/">设计模式<span class="sidebar_archives-count">5</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/yousida" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.svg);">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    
        <a href="https://www.zhihu.com/people/you-si-da" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-zhihu.svg);">
                <span class="visuallyhidden">Zhihu</span>
            </button><!--
     --></a>
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;游思达的博客
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->

    <script src="/js/lazyload.min.js"></script>
    <script src="/js/js.min.js"></script>



    <script src="/js/nprogress.js"></script>


<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>
















<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script>
    <!-- Offer LazyLoad -->
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    <!-- Start Queue -->
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

                </main>
            </div>
        </body>
    
</html>
